name: Scheduled Email Notifications

on:
  schedule:
    # Low stock check - every hour
    - cron: '0 * * * *'
    # Daily report - every day at 9 AM UTC (adjust timezone as needed)
    - cron: '0 9 * * *'
    # Weekly summary - every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Which cron job to run'
        required: true
        type: choice
        options:
          - low-stock
          - daily-report
          - weekly-summary
          - all

jobs:
  run-cron-jobs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get current job type
        id: job-type
        run: |
          # Determine which job to run based on schedule or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.job_type }}" >> $GITHUB_OUTPUT
          else
            # Determine from schedule
            HOUR=$(date -u +%H)
            DAY=$(date -u +%u)
            
            if [ "$DAY" = "1" ] && [ "$HOUR" = "09" ]; then
              echo "type=weekly-summary" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "09" ]; then
              echo "type=daily-report" >> $GITHUB_OUTPUT
            else
              echo "type=low-stock" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run Low Stock Check
        if: steps.job-type.outputs.type == 'low-stock' || steps.job-type.outputs.type == 'all'
        run: |
          curl -X POST ${{ secrets.VERCEL_URL }}/api/cron/low-stock-check \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json"

      - name: Run Daily Report
        if: steps.job-type.outputs.type == 'daily-report' || steps.job-type.outputs.type == 'all'
        run: |
          curl -X POST ${{ secrets.VERCEL_URL }}/api/cron/daily-report \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json"

      - name: Run Weekly Summary
        if: steps.job-type.outputs.type == 'weekly-summary' || steps.job-type.outputs.type == 'all'
        run: |
          curl -X POST ${{ secrets.VERCEL_URL }}/api/cron/weekly-summary \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json"
